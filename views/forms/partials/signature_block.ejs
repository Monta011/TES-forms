<div class="space-y-4">
  <% if (title) { %>
    <h3 class="text-lg font-semibold text-gray-800"><%= title %></h3>
    <p class="text-sm text-gray-600"><%= subtitle || '' %></p>
  <% } %>

  <div>
    <div class="border rounded-lg overflow-hidden bg-white">
      <canvas id="<%= idPrefix %>Canvas" class="w-full h-48"></canvas>
    </div>

    <!-- Controls + Inline date on desktop, stacked on mobile -->
    <div class="mt-2 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div class="flex gap-2">
        <button type="button" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm" data-action="clear" data-target="<%= idPrefix %>">Clear</button>
        <button type="button" class="px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm" data-action="save" data-target="<%= idPrefix %>">Save Signature</button>
      </div>
      <div class="md:flex md:items-center md:gap-2 w-full md:w-auto">
        <label for="<%= idPrefix %>Date" class="block md:inline text-sm font-medium text-gray-700 md:mb-0 mb-1">Date</label>
        <input type="date" id="<%= idPrefix %>Date" name="<%= dateFieldName %>" value="<%= formData[dateFieldName] || '' %>" class="w-full md:w-48 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
    </div>

    <input type="hidden" name="<%= fieldName %>" id="<%= idPrefix %>Input" value="<%= formData[fieldName] || '' %>">
    <% if (errors && errors[fieldName]) { %>
      <p class="text-red-500 text-sm mt-1"><%= errors[fieldName] %></p>
    <% } %>
    <% if (errors && errors[dateFieldName]) { %>
      <p class="text-red-500 text-sm mt-1"><%= errors[dateFieldName] %></p>
    <% } %>
  </div>
</div>
<script>
  window.__initSignaturePad = window.__initSignaturePad || function(idPrefix) {
    const canvas = document.getElementById(idPrefix + 'Canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const input = document.getElementById(idPrefix + 'Input');

    function resize() {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width = rect.width * ratio;
      canvas.height = 192 * ratio; // h-48 â‰ˆ 192px
      canvas.style.width = rect.width + 'px';
      canvas.style.height = '192px';
      ctx.scale(ratio, ratio);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111827';
    }
    resize();
    window.addEventListener('resize', resize);

    let drawing = false;
    let last = null;
    function start(e) {
      drawing = true;
      last = getPos(e);
    }
    function move(e) {
      if (!drawing) return;
      const pos = getPos(e);
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      last = pos;
    }
    function end() { drawing = false; }

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches && e.touches[0];
      const x = (touch ? touch.clientX : e.clientX) - rect.left;
      const y = (touch ? touch.clientY : e.clientY) - rect.top;
      return { x, y };
    }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);

    canvas.addEventListener('touchstart', start, { passive: true });
    canvas.addEventListener('touchmove', move, { passive: true });
    window.addEventListener('touchend', end);

    // Buttons
    const dateInput = document.getElementById(idPrefix + 'Date');
    function todayISO() {
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return d.getFullYear() + '-' + m + '-' + day;
    }

    document.querySelectorAll('[data-target="' + idPrefix + '"]').forEach(btn => {
      const action = btn.getAttribute('data-action');
      if (action === 'clear') {
        btn.addEventListener('click', () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          input.value = '';
          if (dateInput) dateInput.value = '';
        });
      } else if (action === 'save') {
        btn.addEventListener('click', () => {
          input.value = canvas.toDataURL('image/png');
          if (dateInput) dateInput.value = todayISO();
        });
      }
    });
  };

  // Initialize after DOM loaded
  document.addEventListener('DOMContentLoaded', () => {
    __initSignaturePad('<%= idPrefix %>');
  });
</script>
